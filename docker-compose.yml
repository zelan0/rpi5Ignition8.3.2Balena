version: '2.4'

volumes:
  ignition-data:
  ignition-logs:

services:
  ignition:
    build: .
    restart: always
    labels:
      io.balena.features.dbus: '1'
      io.balena.features.supervisor-api: '1'
    ports:
      - "8088:8088"
      - "8043:8043"
      - "8044:8044"
      - "8000:8000"
    volumes:
      - ignition-data:/opt/ignition/data
      - ignition-logs:/opt/ignition/logs
    environment:
      # Headless mode optimizations
      - BALENA_HOST_CONFIG_gpu_mem=256
      - BALENA_HOST_CONFIG_disable_splash=1
      - BALENA_HOST_CONFIG_dtparam=audio=off
      # Optional: Enable hardware interfaces if needed
      # - BALENA_HOST_CONFIG_dtparam=i2c_arm=on
      # - BALENA_HOST_CONFIG_dtparam=spi=on
      # - BALENA_HOST_CONFIG_dtparam=uart0=on
    # Health check for Ignition
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8088"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
